# Руководство пользователя “Журнал регистрации УТЗ”

Это корпоративное приложение для регистрации документов по оборудованию с автоматической нумерацией. Поддерживает совместную работу, уникальность по бизнес‑правилам, “золотые” номера, отчёты и Excel‑выгрузки.

- Веб‑доступ: http://ВАШ_СЕРВЕР/ (пример: http://10.202.220.143/)
- Язык интерфейса: русский
- Часовой пояс: Europe/Moscow
- Роли:
  - Администраторы: vgrubtsov, yuaalekseeva, lrshlyogin, pyagavrilov
  - Пользователи: все остальные
- Идентификация: заголовок X‑User подставляется автоматически (реверс‑прокси Nginx). Открывайте UI только через http://ВАШ_СЕРВЕР/ (прямой порт приложения без прокси запрашивать не нужно).

---

## 1) Ключевые принципы работы

- Автонумерация документов
  - Формат: “УТЗ‑” + 6 цифр, например “УТЗ‑000123”.
  - Нумерация монотонна, после импорта исторических данных начинается от max+1. Старые “дыры” не дозаполняются.

- “Золотые” номера (…00)
  - Номера, оканчивающиеся на “00”, называются “золотыми”.
  - Пользователи их не получают (такие номера пропускаются).
  - Администраторы могут специально резервировать/занимать “золотые” номера.

- Уникальность документа
  - Пара (“Наименование документа”, “Примечание”, “Оборудование”) должна быть уникальна.
  - При нарушении получаете понятное сообщение: “Такой документ уже зарегистрирован.”

- Совместная работа и пулы номеров
  - Перед созданием документов резервируется пул из N номеров (сессия).
  - Каждый пользователь получает свой набор, конкуренция безопасна; номера не дублируются.
  - Неиспользованные резервы можно отменить вручную или они истекут по времени (TTL).

- Подсказки и автодополнение
  - В “Наименовании документа” — подсказки из ранее введённых значений.
  - В оборудовании — каскадные подсказки по полям (например, по выбранной “Станции / Объекту”).

- Права
  - Пользователь: создаёт оборудование, резервирует номера, создаёт документы.
  - Администратор: дополнительно может резервировать конкретные номера (включая …00), редактировать документы/оборудование, импортировать Excel.

- Отчёты
  - Фильтры по “Станция / Объект” (одно или несколько значений) и при необходимости по времени.
  - Excel‑выгрузка в требуемом формате.

---

## 2) Сущности (что к чему привязано)

- Оборудование — карточка с полями: тип, заводской/заказной номера, маркировка, станционный номер, “Станция / Объект”, примечания.
- Сессия — ваш резерв пулов номеров (N штук) для выбранного оборудования.
- Документ — запись журнала с уникальным номером “УТЗ‑000XYZ”, наименованием и примечанием, привязанный к оборудованию.
- Отчёт — представление документов с деталями оборудования и автора (ФИО/отдел, если заполнены). Можно сохранить в Excel.

---

## 3) Быстрый старт (за 10 минут)

1) Создайте оборудование: раздел “Оборудование” → заполните “Тип оборудования” → Сохранить.
2) Зарезервируйте номера: раздел “Резерв номеров” → укажите ID оборудования и N → Резервировать.
3) Создайте документ: там же ниже → укажите ID сессии, введите “Наименование документа” и “Примечание” → Назначить.
4) Посмотрите в отчёте: раздел “Отчёты” → при желании отфильтруйте по “Станция / Объект” → Показать → Сохранить в Excel.

После действий в UI возле кнопок появляются “плашки” с результатом (создано/ошибка), поэтому “ничего не происходит” — это скорее ошибка заполнения; смотрите подсказку рядом.

---

## 4) Пошаговая инструкция (подробно)

### 4.1. Создать оборудование

- Откройте: “Оборудование” (/ui/equipment).
- Заполните:
  - Обязательное поле: “Тип оборудования”.
  - Дополнительно: “№ заводской”, “№ заказа”, “Маркировка”, “№ станционный”, “Станция / Объект”, “Примечания”.
- Нажмите “Сохранить”.
- Внизу появится плашка, например: “Создано оборудование: ID=12, тип: Турбина”.

Подсказки:
- По мере ввода появятся выпадающие варианты (автодополнение) по уже существующим значениям.

Кто может:
- Создавать — все пользователи.
- Редактировать — только администратор (через админский функционал).

---

### 4.2. Зарезервировать номера (создать пул)

- Откройте: “Резерв номеров” (/ui/session), первая форма.
- Введите:
  - ID оборудования (из предыдущего шага).
  - Количество N (по умолчанию 1).
- Нажмите “Резервировать”.
- Появится плашка с вашим ID сессии и списком зарезервированных номеров (например: “Сессия: …; Зарезервировано: 23, 24, 25”).

Важно:
- Для обычных пользователей номера “…00” (золотые) будут пропущены.
- TTL резерва ограничен; если не планируете использовать — отмените вручную (кнопка “Отменить”, если предусмотрена) или создайте новый резерв позднее.

---

### 4.3. Создать документ (назначить номер)

- На той же странице “Резерв номеров”, вторая форма.
- Введите:
  - ID вашей сессии.
  - “Наименование документа”.
  - “Примечание”.
- Нажмите “Назначить следующий номер”.
- Появится плашка: “Документ создан: № УТЗ‑000XYZ”.

Ошибки и решения:
- “Такой документ уже зарегистрирован.” — у этой комбинации (“Наименование”, “Примечание”, “Оборудование”) уже есть запись. Измените значения или оборудование.
- “В пуле только номера ХХХХ00, недоступные обычному пользователю.” — обратитесь к администратору за “золотыми” номерами или резервируйте новый пул.

---

### 4.4. Отчёты (JSON/Excel)

- Откройте: “Отчёты” (/ui/reports).
- Фильтры:
  - “Станция / Объект”: можно одно значение или несколько через запятую.
  - Период (“Дата от/до”): опционально. Если указана только одна дата — вторая подставится (по умолчанию от начала недели до текущего момента).
- Нажмите “Показать” — увидите таблицу (данные по документам).
- Нажмите “Сохранить в Excel” — получите путь к XLSX на сервере.

Примечания:
- Столбцы Excel: “№ документа”, “Дата регистрации”, “Наименование документа”, “Примечание”, “Тип оборудования”, “№ заводской”, “№ заказа”, “Маркировка”, “№ станционный”, “Станция / Объект”, “Фамилия”, “Имя”, “Отчество”, “Отдел”.
- Если ФИО/отдел у автора не заполнены — подставляется “Имя пользователя в системе”.

---

### 4.5. Администратор: “золотые” номера и редактирование

- “Золотые” номера (…00)
  - Раздел: “Админ: золотые номера” (/ui/admin).
  - Кнопка “Показать ближайшие ХХХХ00” — список свободных номеров кратных 100.
  - “Резерв конкретных номеров” — введите ID оборудования и номера (CSV), нажмите “Резерв”. Получите плашку с ID админ‑сессии; далее назначайте документы как обычно.

- Редактирование документов/оборудования
  - Администратор может в админских интерфейсах менять “Наименование документа”, “Примечание” и данные оборудования.
  - Все изменения по документам фиксируются в аудите: когда, кем, какие поля и как были изменены.

---

### 4.6. Отмена/истечение резерва (TTL)

- Если заранее зарезервированные номера не нужны — отмените сессию (если в UI есть кнопка “Отменить”) или дождитесь окончания TTL.
- После отмены/TTL номера автоматически возвращаются в общий пул и могут быть выданы вновь.

---

## 5) Подсказки и лучшие практики

- Резервируйте ровно столько номеров, сколько планируете использовать — так меньше “заморозок” и проще учёт.
- Для часто повторяющихся “Наименование документа”/“Примечание” пользуйтесь автоподсказками — так меньше опечаток и дублей.
- Планируйте отчёты по “Станция / Объект” — это основной фильтр для выгрузки.
- Если вам нужны “особые” номера “…00” — привлекайте администратора (пользователь их не получит).

---

## 6) Частые вопросы и быстрые решения

- UI просит “Требуется заголовок X‑User …”
  - Открыли не тот адрес. Работайте через http://ВАШ_СЕРВЕР/ (через Nginx). Прямой порт приложения (127.0.0.1:8000) без заголовка X‑User — вернёт 401.

- Нажимаю “Сохранить”, а “ничего не происходит”
  - Теперь формы показывают плашки‑результаты рядом. Если плашки нет — перелистните страницу чуть ниже, либо посмотрите в браузере “Сеть” (Network) → запрос → код ответа.
  - Если код 422 — проверьте, что обязательные поля заполнены.

- Отчёт (GET /reports) возвращает 422
  - Это бывшая проблема пустых дат. Сейчас поля “Дата от/до” можно оставлять пустыми: подставятся дефолты.

- “Такой документ уже зарегистрирован.”
  - Измените “Наименование документа”/“Примечание” или оборудование — уникальность по (наименование, примечание, оборудование).

- В пул попали только “…00” (я не админ)
  - Создайте новый пул или попросите администратора занять “золотые” номера.

- Где мой Excel‑файл?
  - Система выведет путь к файлу на сервере. Обычно это каталог var/exports. Обратитесь к администратору, если нужен доступ/пересылка.

---

## 7) Пример сценария (от и до)

1) Создаю оборудование:
   - Тип: “Турбина”, Заводской №: “14881488”, Станция/Объект: “Нижне‑Косячная ТЭЦ‑14”.
   - Жму “Сохранить” → плашка с ID=… и типом.

2) Резервирую 3 номера:
   - Ввожу ID оборудования и N=3 → “Резервировать”.
   - Вижу плашку: “Сессия: …; Зарезервировано: 27, 28, 29”.

3) Создаю документ:
   - Ввожу ID сессии, “Наименование документа”: “Паспорт”, “Примечание”: “Первичный” → “Назначить”.
   - Плашка: “Документ создан: № УТЗ‑000027”.

4) Отчёт:
   - Перехожу в “Отчёты”, указываю “Станция / Объект”: “Нижне‑Косячная ТЭЦ‑14”.
   - Нажимаю “Показать” → вижу строку с документом.
   - “Сохранить в Excel” — получаю путь к файлу на сервере.

---

## 8) Для продвинутых (API‑клиенты)

Если нужно работать через Postman/Bruno:
- Во всех запросах указывайте заголовок X‑User: <ваш_логин>.
- Основные эндпоинты:
  - POST /equipment — создать оборудование (JSON)
  - POST /sessions — резерв номеров (JSON или Form)
  - POST /documents/assign-one — создать документ (JSON или Form)
  - GET /reports — отчёты (JSON)
  - GET /reports/excel — Excel
  - Админ: GET /admin/golden-suggest, POST /admin/reserve-specific

---

## 9) Поддержка

Если что‑то не работает:
- Укажите URL, точное время, что делали, и приложите скриншот/сообщение об ошибке.
- По вопросам доступа, выгрузок Excel и админских операций — обращайтесь к вашему локальному администратору.

Приятной работы!
