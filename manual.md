# Руководство пользователя “Журнал регистрации УТЗ”

Это приложение помогает регистрировать документы по оборудованию с автонумерацией вида “УТЗ-000001”, ведёт журнал, формирует отчёты и поддерживает совместную работу (резерв пулов номеров).

- Веб‑интерфейс (UI): http://ВАШ_СЕРВЕР/ (например, http://10.202.220.143/)
- Язык интерфейса: русский
- Часовой пояс: Europe/Moscow
- Роли:
  - Администраторы (логины): vgrubtsov, yuaalekseeva, lrshlyogin, pyagavrilov
  - Пользователи: все остальные

Важно про вход
- Для UI авторизация упрощённая — по заголовку X-User. В вашей сети перед приложением стоит Nginx, который автоматически подставляет X-User, поэтому UI работает “из коробки” по адресу http://ВАШ_СЕРВЕР/.
- Прямой доступ к API-движку (например, http://127.0.0.1:8000/) без заголовка X-User вернёт 401. Для работы используйте адрес через Nginx.

---

## Меню и разделы

- Главная (/) — быстрые ссылки на основные разделы
- Оборудование (/ui/equipment) — добавление карточек оборудования
- Резерв номеров (/ui/session) — резерв пулов и создание документов
- Админ: золотые номера (/ui/admin) — функции администратора
- Отчёты (/ui/reports) — просмотр и выгрузка в Excel

Подсказки:
- Поля с выпадающими подсказками появляются по мере ввода (наименования документов, атрибуты оборудования).
- Внутри форм обязательные поля помечены как required.

---

## Бизнес‑правила (как работает нумерация и проверки)

- Номер документа формируется автоматически: “УТЗ-” + 6 цифр (например, УТЗ‑000123).
- “Золотые” номера — те, что оканчиваются на 00 (…00).
  - Обычным пользователям недоступны, пропускаются автоматически.
  - Администраторы могут занимать такие номера целенаправленно.
- Уникальность записи:
  - Комбинация (“Наименование документа”, “Примечание”, “ID оборудования”) должна быть уникальной.
  - При попытке дублирования — сообщение: “Такой документ уже зарегистрирован.”
- Совместная работа и пулы:
  - Вы указываете количество N — система резервирует вам пул из N номеров.
  - Пока номера в пуле не назначены документам, они удерживаются за вашей сессией.
  - По кнопке “Отменить” или по истечении времени (TTL) резерв аннулируется, номера возвращаются в общий доступ.
- После импорта исторических данных:
  - Новые номера идут монотонно от максимального+1; “дыры” из прошлого не заполняются.

---

## Шаг 1. Оборудование

Раздел: /ui/equipment

1) Откройте “Оборудование”.
2) Заполните поля:
   - Обязательно: “Тип оборудования”.
   - Остальное — по необходимости (“№ заводской”, “№ заказа”, “Маркировка”, “№ станционный”, “Станция / Объект”, “Примечания”).
3) Нажмите “Сохранить” — появится созданная карточка с ID оборудования.

Подсказки:
- По мере ввода значений вам будут предлагаться варианты из уже существующих записей (автодополнение).

Кто может:
- Создавать оборудование — все пользователи.
- Редактировать оборудование — только администраторы.

---

## Шаг 2. Резерв номеров

Раздел: /ui/session

1) Введите ID оборудования (из шага 1).
2) Укажите количество номеров для резерва (N). По умолчанию 1.
3) Нажмите “Резервировать”.
   - Система выдаст пул из N номеров (обычным пользователям номера “…00” будут пропущены).

Примечание:
- Резерв удерживается ограниченное время (TTL). Если вы не успели — можно заново зарезервировать.

---

## Шаг 3. Назначение номера и создание документа

Раздел: /ui/session (вторая форма на странице)

1) Введите ID вашей сессии (выдан при резерве).
2) Заполните:
   - “Наименование документа” (обязательно; с подсказками)
   - “Примечание” (обязательно)
3) Нажмите “Назначить следующий номер”.
   - Будет создан документ: номер берётся из вашего пула.
   - Отобразится информация о созданном документе (включая форматированный № “УТЗ-000XYZ”).

Важные сообщения:
- “Такой документ уже зарегистрирован.” — измените “Наименование документа”/“Примечание” или используйте другое оборудование.
- “В пуле только номера ХХХХ00, недоступные обычному пользователю.” — обратитесь к администратору или создайте новый пул.

Отмена:
- Если хотите отменить резерв — нажмите “Отменить” в разделе сессий (или подождите окончания TTL).

---

## Администратор: работа с “золотыми” номерами и редактирование

Раздел: /ui/admin

1) Подсказка ближайших свободных “золотых” номеров
   - Нажмите “Показать ближайшие ХХХХ00” — список ближайших свободных номеров, кратных 100.
2) Резерв конкретных номеров
   - Укажите ID оборудования и список номеров через запятую (например, 100, 200).
   - Нажмите “Резерв”.
   - Далее назначайте документы обычным образом, указывая ID созданной сессии.
3) Редактирование документа
   - Администратор может найти запись по номеру документа или по оборудованию и изменить “Наименование документа”/“Примечание”.
   - Все изменения логируются (аудит): фиксируются дата, пользователь и какие поля изменились (старое/новое).

Ограничения:
- Только администратор может редактировать оборудование и документы.

---

## Отчёты

Раздел: /ui/reports

1) Фильтры:
   - “Станция / Объект” — можно указать одно или несколько значений (через запятую).
   - Период — “Дата от” / “Дата до” (необязательно). Если указать только одну границу, другая подставится автоматически (по умолчанию от начала недели до текущего момента).
2) Кнопка “Показать” — список записей в виде таблицы (JSON-представление).
3) “Сохранить в Excel” — выгрузит отчёт в XLSX.
   - Состав Excel:
     - “№ документа”, “Дата регистрации”, “Наименование документа”, “Примечание”,
     - “Тип оборудования”, “№ заводской”, “№ заказа”, “Маркировка”, “№ станционный”, “Станция / Объект”,
     - “Фамилия”, “Имя”, “Отчество”, “Отдел”.
     - Если данных ФИО/отдела нет — подставляется “Имя пользователя в системе”.

Где искать файл Excel:
- Файл сохраняется на сервере. Если настроено отображение выгрузок в общей папке — следуйте инструкциям вашего администратора. Иначе запросите файл у администратора (система выводит путь к файлу при сохранении).

---

## Подсказки и автодополнение

- “Наименование документа” — выпадающие подсказки из ранее введённых значений.
- Оборудование:
  - Можно выбирать значение “Станция / Объект” — и в “№ станционный”/“Маркировка” будут предлагаться соответствующие варианты.
  - Аналогично от “№ заводской” можно уточнять другие поля.

---

## Частые вопросы и ошибки

- “Требуется заголовок X-User (Имя пользователя в системе).”
  - Вы открыли прямой адрес API (например, http://127.0.0.1:8000/). Для UI используйте адрес через Nginx — http://ВАШ_СЕРВЕР/ (заголовок X-User добавляется автоматически).
- “Такой документ уже зарегистрирован.”
  - Комбинация (“Наименование документа”, “Примечание”, “Оборудование”) должна быть уникальной. Измените значения и повторите.
- “В пуле только номера ХХХХ00, недоступные обычному пользователю.”
  - Попросите администратора выдать “золотые” номера или зарезервируйте новый пул — система выдаст обычные номера (не “…00”).
- “Не вижу Excel‑файл.”
  - Скачайте через кнопку “Сохранить в Excel” и следуйте инструкции на экране (или обратитесь к администратору — файл записывается на сервере).
- “Номер скачет/пропадает?”
  - Номер резервируется в вашей сессии. Если сессию отменить или просрочить (TTL), номера освобождаются и могут быть выданы заново.

---

## Мини‑памятка по ролям

Пользователь:
- Создаёт оборудование.
- Резервирует N номеров.
- Создаёт документы, заполняя только “Наименование документа” и “Примечание”.
- Не может использовать номера “…00”.

Администратор:
- Всё то же, плюс:
  - Может выбирать конкретные номера, в том числе “золотые” (…00).
  - Может редактировать оборудование.
  - Может редактировать документы (изменения пишутся в аудит‑лог).
  - Может импортировать данные из Excel (если эта функция включена в вашей установке).

---

## Примеры (для продвинутых пользователей)

Если вы обращаетесь к API напрямую (Postman/Bruno):
- Обязательно добавляйте заголовок X-User: <ваш_логин>.
- Базовые эндпоинты:
  - POST /equipment — создать оборудование
  - POST /sessions — получить пул номеров (резерв)
  - POST /documents/assign-one — создать документ на основе пула
  - GET /reports — отчёт (JSON)
  - GET /reports/excel — отчёт (Excel)
  - Админ: GET /admin/golden-suggest, POST /admin/reserve-specific

Пример запроса (curl):
```
# Создать оборудование
curl -H 'X-User: lrshlyogin' -H 'Content-Type: application/json' \
  -d '{"eq_type":"EQ1"}' \
  http://ВАШ_СЕРВЕР/equipment

# Резерв (N=1):
curl -H 'X-User: lrshlyogin' -H 'Content-Type: application/json' \
  -d '{"equipment_id":1,"requested_count":1}' \
  http://ВАШ_СЕРВЕР/sessions

# Назначить документ
curl -H 'X-User: lrshlyogin' -H 'Content-Type: application/json' \
  -d '{"session_id":"<SESSION_ID>","doc_name":"Док A","note":"Прим A"}' \
  http://ВАШ_СЕРВЕР/documents/assign-one

# Отчёт
curl -H 'X-User: lrshlyogin' http://ВАШ_СЕРВЕР/reports
```

---

## Рекомендации по работе

- Создавайте оборудование заранее — так быстрее и удобнее работать с документами.
- Резервируйте ровно столько номеров, сколько планируете использовать в ближайшее время — не “замораживайте” лишние.
- Если вам часто нужны одинаковые “Наименование документа”/“Примечание” — используйте автоподсказки.
- Для “особых” номеров (…00) всегда подключайте администратора.

---

## Обратная связь и поддержка

Если что‑то работает не так:
- Сообщите точное время, URL и сообщение об ошибке.
- При возможности — приложите скриншот и короткое описание, как воспроизвести.
- Контакты локального администратора/команды сопровождения — согласно вашей корпоративной схеме.

Приятной работы!
