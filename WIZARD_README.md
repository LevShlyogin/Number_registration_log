# Wizard для регистрации номеров документов

## Обзор

Wizard представляет собой многошаговый интерфейс для регистрации номеров документов в системе. Он включает в себя поиск/создание оборудования, резерв номеров, назначение номеров и формирование отчетов.

## Основные возможности

### 1. Поиск и создание оборудования
- **Поиск по отдельным полям**: Станция/Объект, № станционный, Маркировка, № заводской
- **Поиск по тексту**: Поиск по "сборной" строке по всем полям одновременно
- **Создание нового оборудования**: С обязательным полем "Тип оборудования" (Турбина/Вспомогательное оборудование)
- **Проверка дублей**: Автоматическая проверка на существование оборудования с такими же атрибутами

### 2. Резерв номеров
- Указание количества номеров для резерва
- Автоматический пропуск "золотых" номеров (..00) для обычных пользователей
- Создание сессии резерва

### 3. Назначение номеров
- Заполнение атрибутов документа (наименование, примечание)
- Автодополнение для полей наименования и примечания
- Пошаговое назначение номеров с отображением в таблице
- Возможность завершения сессии с освобождением неназначенных номеров

### 4. Отчеты
- Расширенные фильтры поиска
- Множественный выбор станций/объектов
- Экспорт в Excel с информацией о пользователе
- Возврат к началу wizard

## Использование

### Доступ к wizard
```
GET /wizard
```

### Поиск оборудования
```
GET /equipment/search?station_object=&station_no=&label=&factory_no=&q=
```

### Создание оборудования
```
POST /equipment
```

### Резерв номеров
```
POST /sessions
```

### Назначение номера
```
POST /documents/assign-one
```

### Завершение сессии
```
POST /sessions/{session_id}/complete
```

### Автодополнение
```
GET /suggest/doc-names?q=
GET /suggest/notes?q=
```

### Отчеты
```
GET /reports
GET /reports/excel
```

## Структура wizard

### Шаг 1: Поиск/Создание оборудования
- Форма поиска с полями
- Кнопка "Создать новый объект"
- Список результатов поиска
- Выбор оборудования для продолжения

### Шаг 2: Резерв номеров
- Поле для указания количества номеров
- Кнопка "Резервировать"
- Отображение результата резерва

### Шаг 3: Назначение номеров
- Поля для атрибутов документа с автодополнением
- Кнопка "Назначить следующий номер"
- Таблица зарегистрированных номеров
- Кнопка "Завершить"

### Шаг 4: Отчеты
- Фильтры поиска
- Кнопки "Показать", "Сохранить в Excel", "Вернуться в начало"
- Отображение результатов

## Технические особенности

### Валидация дублей оборудования
- Уникальный индекс на комбинацию полей (station_object, station_no, label, factory_no)
- Регистронезависимое сравнение (CITEXT)
- Обработка NULL значений

### Автодополнение
- Поиск по существующим значениям в базе данных
- ILIKE поиск для частичного совпадения
- Ограничение результатов (20 записей)

### HTMX интеграция
- Динамическое обновление UI без перезагрузки страницы
- Формы с поддержкой application/x-www-form-urlencoded
- Возврат HTML фрагментов для HTMX запросов

## Миграции базы данных

### Добавление уникального индекса на оборудование
```sql
CREATE UNIQUE INDEX ix_equipment_unique_attributes 
ON equipment (
    LOWER(COALESCE(station_object, '')), 
    LOWER(COALESCE(station_no, '')), 
    LOWER(COALESCE(label, '')), 
    LOWER(COALESCE(factory_no, ''))
)
WHERE station_object IS NOT NULL 
   OR station_no IS NOT NULL 
   OR label IS NOT NULL 
   OR factory_no IS NOT NULL;
```

## Тестирование

Запуск тестов:
```bash
pytest tests/test_wizard_basic.py -v
```

## Требования

- FastAPI
- SQLAlchemy 2.0 (async)
- PostgreSQL 15
- HTMX
- Bootstrap 5
- Alembic для миграций

## Планы развития

- [ ] Переход на авторизацию через логин/пароль
- [ ] Улучшение UI/UX
- [ ] Добавление дополнительных фильтров
- [ ] Интеграция с внешними системами
